@model ClassLibrary.ViewModels.MopViewModels
<script src="~/Scripts/jquery.validate.min.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.js"></script>
<link href="~/Content/morris.css" rel="stylesheet" />
<link href="~/Content/Digtalstyle.css" rel="stylesheet" />
<script src="~/Content/Digitalscript.js"></script>
<script src="~/Scripts/moment.min.js"></script>
<link href="~/Scripts/themes/default/style.min.css" rel="stylesheet" />
<script src="~/Scripts/jstree.min.js"></script>
<link href="~/Content/select.dataTables.min.css" rel="stylesheet" />
<script src="~/Scripts/dataTables.select.min.js"></script>

<link href="~/Content/sweetalert.css" rel="stylesheet" />
<script src="~/Scripts/sweetalert.min.js"></script>

<style>
    .modal-dialog {
        width: 80% !important;
    }

    .avatar-preview {
        width: 192px;
        height: 192px;
        position: relative;
        border: 6px solid #F8F8F8;
        box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.1);
    }

    a {
        cursor: pointer;
    }
</style>


@*<script>
        $('#gridMop').DataTable();
    </script>*@


<script>
    var table;
    var editTable;
    var mopItemTable;
    $(document).ready(function () {
        $("#gridMopItemsDiv").hide();
        $("#Proceed").click(function () {

           $("#gridMopItemsDiv").show();

           //$("#M_MOP_ITEMS_PMS_No").val($('#PMS_No').val());
           //$("#M_MOP_ITEMS_MOP_No").val($('#M_MOP_ITEMS_MOP_No').val());
        });

        $("#M_MOP_ITEMS_MOP_No").attr('disabled', true);
        $("#AddMOP_No").attr('disabled', true);
        $("#Proceed").attr('disabled', true);

         $("#PMS_No").change(function () {
            var PMS_No = $(this).val();

            $.ajax({
                type: "post",
                //   url: "/RoadTrafficAccidentModule/GetVehicleMakeList?VehicleTypeID=" + VehicleTypeID,
                url: '@Url.Action("GetMOP", "MOP")?PMS_No=' + PMS_No,
                contentType: "html",
                success: function (response) {
                    $("#M_MOP_ITEMS_MOP_No").removeAttr('disabled');
                    $("#Proceed").removeAttr('disabled');
                    $("#M_MOP_ITEMS_MOP_No").empty();
                    $("#M_MOP_ITEMS_MOP_No").append(response);
                },
            });
        });



         $("#AddPMS_No").change(function () {
            var PMS_No = $(this).val();

            $.ajax({
                type: "post",
                //   url: "/RoadTrafficAccidentModule/GetVehicleMakeList?VehicleTypeID=" + VehicleTypeID,
                url: '@Url.Action("GetMOP", "MOP")?PMS_No=' + PMS_No,
                contentType: "html",
                success: function (response) {
                    $("#AddMOP_No").removeAttr('disabled');
                    $("#AddMOP_No").empty();
                    $("#AddMOP_No").append(response);
                },
            });
        });


         table = $('#AddMOPItemTable').DataTable({
             'columnDefs': [{
                 targets: 0,
                 data: null,
                 defaultContent: '',
                 orderable: false,
                 className: 'select-checkbox'
             }],
             select: {
                 style: 'os',
                 selector: 'td:first-child'
             },
             order: [[1, 'asc']]
         });

         $('#AddMOPItemTable tbody').on("click", '.select-checkbox', function () {
             var tblData = table.rows($(this).closest('tr')).data();
             var selectedData;
             $.each(tblData, function (i, val) {
                 selectedData = tblData[i];
             });
             console.log(selectedData);
             var partNo = selectedData[1];
             console.log(partNo);
         //    var cageCode = selectedData[4];
             $('#M_MOP_ITEMS_Part_No').val(partNo);
          //   $('#C_Site_Config_CageCode').val(cageCode);

         });


        editTable = $('#EditMOPItemTable').DataTable({
             'columnDefs': [{
                 targets: 0,
                 data: null,
                 defaultContent: '',
                 orderable: false,
                 className: 'select-checkbox'
             }],
             select: {
                 style: 'os',
                 selector: 'td:first-child'
             },
             order: [[1, 'asc']]
         });

         $('#EditMOPItemTable tbody').on("click", '.select-checkbox', function () {
             var tblData = editTable.rows($(this).closest('tr')).data();
             var selectedData;
             $.each(tblData, function (i, val) {
                 selectedData = tblData[i];
             });
             console.log(selectedData);
             var partNo = selectedData[1];
             alert(partNo);
             $('#editNewPartNo').val(partNo);
         });
    });


    function GetMaterialListData() {
          var siteId = $("#M_MOP_ITEMS_SiteId").val();
          var pmsNo = $('#PMS_No').val();
          var mopNo = $('#M_MOP_ITEMS_MOP_No').val();

        $("#AddSiteId").val(siteId);
        $("#AddPMSNo").val(pmsNo);
        $("#AddMOPNo").val(mopNo);

        $.ajax({
                cache: 'false',
                type: "Post",

            url: '@Url.Action("TaskMaterialListData", "MOP")',

            dataType: 'json',
            data: {
                siteId: siteId,
                pmsNo: pmsNo,
                mopNo: mopNo
            },
            success: OnSuccess,
            failure: function (response) {
                swal({
                    title: "Oops...", text: "No Data Found!", type: "error",
                });
            },
            error: function (response) {
                swal({
                    title: "Oops...", text: "No Data Found!", type: "error",
                });
            },
        });
    };
  
    function OnSuccess(response) {
            $("#addMOPItem").modal('hide'); $("#editMOPItem").modal('hide'); $("#delMOPItem").modal('hide');
            $("#gridMopItems").DataTable().destroy();
            mopItemTable = $("#gridMopItems").DataTable(
                {
                    scrollX: true,
                    bLengthChange: true,
                    lengthMenu: [[5, 10, -1], [5, 10, 15, "All"]],
                    bFilter: true,
                    bSort: true,
                    bPaginate: true,
                    data: response,

                    columns: [
                        { 'data': 'MOP_ItemsId', "visible": true },
                        { 'data': 'SiteId' },
                        { 'data': 'PMS_No' },
                        { 'data': 'MOP_No' },
                        { 'data': 'SR_Qty' },
                        { 'data': 'Part_No' },


                        {
                            'data': function (data, type, row, meta) {
                                return '<a data-toggle="modal" data-target="#editMOPItem"  class="btn-primary btn-sm select">' + 'Edit' + '</a>' + '|' + '<a data-toggle="modal"  data-target="#delMOPItem"  class="btn-danger btn-sm select">' + 'Delete' + '</a>'
                            }

                        },
                    ]
                });
            if (!$.trim(response)) {
                swal({
                    title: "Oops...", text: "No Data Found!", type: "error",
                });
            }
            else {
                swal({ title: "¡Success!",  type: "success",  timer: 1500,  showConfirmButton: false,
                });
            }
         $('#gridMopItems tbody').on("click", '.select', function () {
            var tblData = mopItemTable.rows($(this).closest('tr')).data();
            console.log(tblData);

            var mopItemId = $(this).closest('tr').find("td:eq(0)").text();
            var siteId = $(this).closest('tr').find("td:eq(1)").text();
            var pmsNo = $(this).closest('tr').find("td:eq(2)").text();
            var mopNo = $(this).closest('tr').find("td:eq(3)").text();
            var srQty = $(this).closest('tr').find("td:eq(4)").text();
            var partNo = $(this).closest('tr').find("td:eq(5)").text();

            $('#mopItemId').val(mopItemId);
            $('#pmsNo').val(pmsNo);
            $('#mopNo').val(mopNo);
            $('#partNo').val(partNo);

            //forEdit
            $('#M_MOP_ItemsModel_SiteId').val(siteId);
            $('#M_MOP_ItemsModel_PMS_No').val(pmsNo);
            $('#M_MOP_ItemsModel_MOP_No').val(mopNo);
            $('#partNo').val(partNo);
            $('#M_MOP_ItemsModel_SR_Qty').val(srQty);




          //  GetSelectedData();
        });
    };

      function AddMOPItemData() {
        $.ajax({
            cache: 'false',
            type: "Post",
            url: '@Url.Action("AddMOPItem", "MOP")',
            dataType: 'json',
            data: {
                //main
                siteId : $("#M_MOP_ITEMS_SiteId").val(),
                pmsNo : $("#PMS_No").val(),
                mopNo : $("#M_MOP_ITEMS_MOP_No").val(),

                SiteId: $("#AddSiteId").val(),
                PMS_No: $("#AddPMSNo").val(),
                MOP_No: $("#AddMOPNo").val(),
                SR_Qty: $("#M_MOP_ITEMS_SR_Qty").val(),
                Part_No: $("#M_MOP_ITEMS_Part_No").val(),
            },
            success: OnSuccess,
            failure: function (response) {
                swal({    title: "ERROR",  text: "Their is something went wrong!!!",   type: "error",  });
            },
            error: function (response) {
                swal({
                    title: "ERROR",
                    text: "Their is something went wrong!!!",
                    type: "error",
                });
            }
        });
    };

      function EditMOPItemData() {
        $.ajax({
            cache: 'false',
            type: "Post",
            url: '@Url.Action("EditMOPItem", "MOP")',
            dataType: 'json',
            data: {
                //main
                siteId: $("#M_MOP_ITEMS_SiteId").val(),
                pmsNo : $("#PMS_No").val(),
                mopNo : $('#M_MOP_ITEMS_MOP_No').val(),

                MOP_ItemsId: $('#mopItemId').val(),
                SiteId: $("#M_MOP_ItemsModel_SiteId").val(),
                PMS_No: $("#M_MOP_ItemsModel_PMS_No").val(),
                MOP_No: $("#M_MOP_ItemsModel_MOP_No").val(),
                SR_Qty: $("#M_MOP_ItemsModel_SR_Qty").val(),
                Part_No: $('#partNo').val(),
                NewSelectedPart_No: $("#editNewPartNo").val(),
            },
            success: OnSuccess,
            failure: function (response) {
                swal({   title: "ERROR",  text: "Their is something went wrong!!!",  type: "error", });
            },
            error: function (response) {
                  swal({    title: "ERROR",  text: "Their is something went wrong!!!",   type: "error",  });
            }
        });
    };


    function DeleteMOPItemData() {

        var mopItemId = $('#mopItemId').val();
        alert(mopItemId);
        $.ajax({
            cache: 'false',
            type: "Post",
            url: '@Url.Action("DeleteMOPItem", "MOP")',
            dataType: 'json',
            data: {
                siteId: $("#M_MOP_ITEMS_SiteId").val(),
                pmsNo: $("#PMS_No").val(),
                mopNo: $("#M_MOP_ITEMS_MOP_No").val(),
                mopItemId: mopItemId
            },
            success:  OnSuccess,
            failure: function (response) {
                swal({  title: "ERROR", text: "Their is something went wrong!!!", type: "error",  });
            },
            error: function (response) {
                swal({      title: "ERROR",    text: "Their is something went wrong!!!",     type: "error",    });
            },
        });
    };
</script>

<!-- Main content -->
<section class="content" style="min-height:0px !important">
    <!-- Small boxes (Stat box) -->
    <div class="row">
        <div class="box">
            <div class="box-header">
                <div class="row">
                    <div class="form-group">
                        <div class="col-md-1"></div>
                        <div class="col-md-3">
                            @Html.DropDownListFor(model => model.M_MOP_ITEMS.SiteId, new SelectList(Model._tbl_Unit, "Id", "Name"), "Select Site", new { @class = "form-control", @required = "true" })
                            @Html.ValidationMessageFor(model => model.M_MOP_ITEMS.SiteId, "", new { @class = "text-danger" })
                        </div>
                        <div class="col-md-3">
                            @Html.DropDownListFor(model => model.M_MOP_ITEMS.PMS_No, new SelectList(Model._M_PMS, "PMS_NO", "PMS_NO"), "Select", new { @class = "form-control", @id = "PMS_No", @required = "true" })
                            @Html.ValidationMessageFor(model => model.M_MOP_ITEMS.PMS_No, "", new { @class = "text-danger" })

                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                @Html.DropDownListFor(model => model.M_MOP_ITEMS.MOP_No, new SelectList(""), "", new { @class = "form-control", @required = "required" })
                                @Html.ValidationMessageFor(model => model.M_MOP_ITEMS.MOP_No, "", new { @class = "text-danger" })
                            </div>
                        </div>
                        <div class="col-md-2">

                            <input type="button" id="Proceed" onclick="GetMaterialListData()" value="Proceed" class="btn btn-primary" />

                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="col-md-12" id="gridMopItemsDiv">
        <div class="row">
            <div class="box box-danger box-solid">
                <div class="box-header with-border">
                    <h3 class="box-title">MOP Items Detail</h3>
                    <div class="box-tools pull-right">

                        <a data-toggle="modal" data-target="#addMOPItem" class="btn btn-success btn-sm"><i class="fa fa-plus"></i> Add MOP Item</a>

                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>


                <div class="box-body">
                    <table id="gridMopItems" class="display" cellspacing="0" width="100%">
                        <thead>
                            <tr>
                                <th>MOP Item</th>
                                <th>Site</th>
                                <th>PMS No</th>
                                <th>MOP NO</th>
                                <th>SR Qty</th>
                                <th>PartNo</th>
                                <th>Actions</th>

                            </tr>
                        </thead>
                    </table>

                </div>
            </div>
        </div>



    </div>

</section>
<input type="hidden" name="mopItemId" id="mopItemId" />
<input type="hidden" name="pmsNo" id="pmsNo" />
<input type="hidden" name="mopNo" id="mopNo" />
<input type="hidden" name="partNo" id="partNo" />
<input type="hidden" name="editNewPartNo" id="editNewPartNo" />

@Html.HiddenFor(model => model.M_MOP_ITEMS.Part_No)
<div id='addMOPItem' class='modal fade'>
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div id='myModalContent'>

                <div class="modal-header">
                    <h4 class="modal-title">Add</h4>

                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>


                <div class="modal-body">
                    @*@Html.HiddenFor(model => model.C_Site_Config.Part_No)
                        @Html.HiddenFor(model => model.C_Site_Config.CageCode)*@
                    <div class="box box-primary box-solid">
                        <div class="box-header with-border">
                            <h3 class="box-title"><b>Add MOP Item</b></h3>
                        </div>
                        <br />

                        <!-- /.card-header -->
                        <!-- form start -->
                        <div class="box-body" id="InputFields">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Site Id</label>
                                        @Html.EditorFor(model => model.M_MOP_ITEMS.SiteId, new { htmlAttributes = new { @class = "form-control", @id = "AddSiteId", @readonly = true } })
                                        @Html.ValidationMessageFor(model => model.M_MOP_ITEMS.SiteId, "", new { @class = "text-danger" })


                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>PMS No.</label>
                                        @Html.EditorFor(model => model.M_MOP_ITEMS.PMS_No, new { htmlAttributes = new { @class = "form-control", @id = "AddPMSNo", @readonly = true } })
                                        @Html.ValidationMessageFor(model => model.M_MOP_ITEMS.PMS_No, "", new { @class = "text-danger" })


                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>MOP No.</label>

                                        @Html.EditorFor(model => model.M_MOP_ITEMS.MOP_No, new { htmlAttributes = new { @class = "form-control", @id = "AddMOPNo", @readonly = true } })
                                        @Html.ValidationMessageFor(model => model.M_MOP_ITEMS.MOP_No, "", new { @class = "text-danger" })


                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>SR Qty</label>

                                        @Html.EditorFor(model => model.M_MOP_ITEMS.SR_Qty, new { htmlAttributes = new { @class = "form-control" } })
                                        @Html.ValidationMessageFor(model => model.M_MOP_ITEMS.SR_Qty, "", new { @class = "text-danger" })

                                    </div>
                                </div>
                            </div>

                            <br />
                            <table id="AddMOPItemTable" class="display" style="width:100%">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Part No</th>
                                        <th>Part Name</th>
                                        <th>Part Type</th>
                                        <th>Cage Code</th>


                                    </tr>
                                </thead>
                                <tbody>


                                    @foreach (var item in Model.tbl_Parts_list)
                                    {
                                        <tr>
                                            <td></td>
                                            <td> @item.Part_No</td>
                                            <td> @item.PART_NAME</td>
                                            <td> @item.tbl_PartType.PartName</td>
                                            <td> @item.CageCode</td>



                                        </tr>
                                    }

                                </tbody>
                            </table>





                        </div>

                    </div>

                    <div class="box-footer" id="footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <input type="button" onclick="AddMOPItemData()" value="Submit" class="btn btn-primary pull-right" />
                    </div>


                </div>


            </div>
        </div>
    </div>
</div>

<div id='editMOPItem' class='modal fade'>
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div id='myModalContent'>

                <div class="modal-header">
                    <h4 class="modal-title">Edit</h4>

                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>


                <div class="modal-body">
                    @*@Html.HiddenFor(model => model.C_Site_Config.Part_No)
                        @Html.HiddenFor(model => model.C_Site_Config.CageCode)*@
                    <div class="box box-primary box-solid">
                        <div class="box-header with-border">
                            <h3 class="box-title"><b>Edit MOP</b></h3>
                        </div>
                        <br />

                        <!-- /.card-header -->
                        <!-- form start -->
                        <div class="box-body" id="InputFields">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Site Id</label>

                                        @Html.EditorFor(model => model.M_MOP_ItemsModel.SiteId, new { htmlAttributes = new { @class = "form-control", @readonly = true } })
                                        @Html.ValidationMessageFor(model => model.M_MOP_ItemsModel.SiteId, "", new { @class = "text-danger" })

                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>PMS No.</label>

                                        @Html.EditorFor(model => model.M_MOP_ItemsModel.PMS_No, new { htmlAttributes = new { @class = "form-control", @readonly = true } })
                                        @Html.ValidationMessageFor(model => model.M_MOP_ItemsModel.PMS_No, "", new { @class = "text-danger" })

                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>MOP No.</label>

                                        @Html.EditorFor(model => model.M_MOP_ItemsModel.MOP_No, new { htmlAttributes = new { @class = "form-control", @readonly = true } })
                                        @Html.ValidationMessageFor(model => model.M_MOP_ItemsModel.MOP_No, "", new { @class = "text-danger" })

                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>SR Qty</label>

                                        @Html.EditorFor(model => model.M_MOP_ItemsModel.SR_Qty, new { htmlAttributes = new { @class = "form-control" } })
                                        @Html.ValidationMessageFor(model => model.M_MOP_ItemsModel.SR_Qty, "", new { @class = "text-danger" })

                                    </div>
                                </div>
                            </div>
                            <br />
                            <table id="EditMOPItemTable" class="display" style="width:100%">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Part No</th>
                                        <th>Part Name</th>
                                        <th>Part Type</th>
                                        <th>Cage Code</th>

                                    </tr>
                                </thead>
                                <tbody>


                                    @foreach (var item in Model.tbl_Parts_list)
                                    {
                                        <tr>
                                            <td></td>
                                            <td> @item.Part_No</td>
                                            <td> @item.PART_NAME</td>
                                            <td> @item.tbl_PartType.PartName</td>
                                            <td> @item.CageCode</td>

                                        </tr>
                                    }

                                </tbody>
                            </table>


                        </div>

                    </div>

                    <div class="box-footer" id="footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <input type="button" onclick="EditMOPItemData()" value="Submit" class="btn btn-primary pull-right" />
                    </div>


                </div>


            </div>
        </div>
    </div>
</div>

<div id='delMOPItem' class='modal fade'>
    <div class="modal-dialog modal-lg" style="width: 40% !important;">
        <div class="modal-content">
            <div id='myModalContent'>

                <div class="modal-header">
                    <h4 class="modal-title"><b>Confirm Delete</b></h4>

                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>


                <div class="modal-body">
                    <h3 style="color:red">Are you sure you want to delete this?</h3>
                </div>
                <div class="modal-footer">
                    <div class="form-actions no-color">
                        <button class="btn btn-default" data-dismiss="modal">Close</button>
                        <input type="submit" onclick="DeleteMOPItemData()" value="Delete" class="btn btn-danger" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
    @Scripts.Render("~/Scripts/Common/ModalPopup.js")
}



